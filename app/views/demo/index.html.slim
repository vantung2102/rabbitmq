- provide(:title, "RabbitMQ & Sidekiq Demo")

section.py-16.bg-base-100
  .container.mx-auto.px-4
    h1.text-center.mb-12.text-4xl.md:text-5xl.font-bold.text-orange-500
      | ğŸš€ Live Demo: RabbitMQ vs Sidekiq

    - if flash[:success]
      .alert.alert-success.mb-6.shadow-lg
        = flash[:success]
    - if flash[:error]
      .alert.alert-error.mb-6.shadow-lg
        = flash[:error]

    .grid.grid-cols-1.lg:grid-cols-2.gap-8
      / Sidekiq Demo
      .bg-base-200.border-2.border-green-500.rounded-xl.p-8.transition-all.hover:-translate-y-1.hover:shadow-lg
        .flex.items-center.gap-4.mb-6.pb-4.border-b-2.border-base-300
          .text-5xl âš¡
          .text-3xl.font-bold.text-green-500 Sidekiq Demo

        .bg-orange-500.bg-opacity-10.border.border-orange-500.rounded-lg.p-4.mb-6
          h4.text-orange-500.font-bold.mb-2 About Sidekiq
          p.text-sm.text-base-content.opacity-80 Fast, simple background job processing for Ruby. Perfect for Rails monoliths with straightforward job queuing needs.

        .grid.grid-cols-2.gap-4.mb-8
          .bg-base-100.p-4.rounded-lg.text-center.border.border-base-300
            .text-3xl.font-bold.text-orange-500#sidekiq-processed 0
            .text-sm.text-base-content.opacity-70 Processed
          .bg-base-100.p-4.rounded-lg.text-center.border.border-base-300
            .text-3xl.font-bold.text-orange-500#sidekiq-workers 0
            .text-sm.text-base-content.opacity-70 Workers
          .bg-base-100.p-4.rounded-lg.text-center.border.border-base-300
            .text-3xl.font-bold.text-orange-500#sidekiq-failed 0
            .text-sm.text-base-content.opacity-70 Failed
          .bg-base-100.p-4.rounded-lg.text-center.border.border-base-300
            .text-3xl.font-bold.text-orange-500#sidekiq-latency 0ms
            .text-sm.text-base-content.opacity-70 Latency

        = form_with url: send_email_demo_index_path, method: :post, local: true, class: "mb-6" do |f|
          h3.text-xl.font-bold.mb-4 ğŸ“§ Send Email Job
          .mb-4
            label.block.text-sm.font-semibold.mb-2.text-base-content.opacity-80 Email Address
            = f.text_field :email, value: "demo@example.com", class: "w-full p-3 bg-base-100 border border-base-300 rounded-lg text-base-content", placeholder: "user@example.com"
          = f.submit "ğŸ“§ Send Email Job", class: "btn btn-success w-full"

        = form_with url: process_image_demo_index_path, method: :post, local: true, class: "mb-6" do |f|
          h3.text-xl.font-bold.mb-4 ğŸ–¼ï¸ Process Image
          .mb-4
            label.block.text-sm.font-semibold.mb-2.text-base-content.opacity-80 Image URL
            = f.text_field :image_url, value: "https://example.com/image.jpg", class: "w-full p-3 bg-base-100 border border-base-300 rounded-lg text-base-content", placeholder: "https://..."
          = f.submit "ğŸ–¼ï¸ Process Image", class: "btn btn-success w-full"

        .bg-base-100.border.border-base-300.rounded-lg.p-4.mt-6.min-h-32.max-h-80.overflow-y-auto
          pre#sidekiq-response.text-sm.font-mono.text-base-content
            | ğŸ“‹ Sidekiq Activity Log
            |
            | Ready to process background jobs!
            |
            | ğŸ’¡ Tips:
            | â€¢ Click "ğŸ“§ Send Email Job" to queue an email worker
            | â€¢ Click "ğŸ–¼ï¸ Process Image" to queue an image processor
            | â€¢ Check /sidekiq for detailed job status
            | â€¢ Jobs will appear here once queued
            |
            | Last activity: None yet

      / RabbitMQ Demo
      .bg-base-200.border-2.border-orange-500.rounded-xl.p-8.transition-all.hover:-translate-y-1.hover:shadow-lg
        .flex.items-center.gap-4.mb-6.pb-4.border-b-2.border-base-300
          .text-5xl ğŸ°
          .text-3xl.font-bold.text-orange-500 RabbitMQ Demo

        .bg-orange-500.bg-opacity-10.border.border-orange-500.rounded-lg.p-4.mb-6
          h4.text-orange-500.font-bold.mb-2 About RabbitMQ
          p.text-sm.text-base-content.opacity-80 Enterprise message broker with powerful routing. Ideal for microservices, event-driven architecture, and complex messaging patterns.

        .grid.grid-cols-2.gap-4.mb-8
          .bg-base-100.p-4.rounded-lg.text-center.border.border-base-300
            .text-3xl.font-bold.text-orange-500#rabbitmq-messages 0
            .text-sm.text-base-content.opacity-70 Messages
          .bg-base-100.p-4.rounded-lg.text-center.border.border-base-300
            .text-3xl.font-bold.text-orange-500#rabbitmq-connections 0
            .text-sm.text-base-content.opacity-70 Connections
          .bg-base-100.p-4.rounded-lg.text-center.border.border-base-300
            .text-3xl.font-bold.text-orange-500#rabbitmq-queues 5
            .text-sm.text-base-content.opacity-70 Queues
          .bg-base-100.p-4.rounded-lg.text-center.border.border-base-300
            .text-3xl.font-bold.text-orange-500#rabbitmq-latency 0ms
            .text-sm.text-base-content.opacity-70 Latency

        = form_with url: create_order_demo_index_path, method: :post, local: true, class: "space-y-6" do |f|
          .mb-6
            h3.text-xl.font-bold.mb-4 ğŸ“¦ Create Order (Topic Exchange)
            .mb-4
              label.block.text-sm.font-semibold.mb-2.text-base-content.opacity-80 Product
              = f.text_field :product, value: "MacBook Pro", class: "w-full p-3 bg-base-100 border border-base-300 rounded-lg text-base-content"
            .mb-4
              label.block.text-sm.font-semibold.mb-2.text-base-content.opacity-80 Amount
              = f.number_field :amount, value: 2999, class: "w-full p-3 bg-base-100 border border-base-300 rounded-lg text-base-content"
            .mb-4
              label.block.text-sm.font-semibold.mb-2.text-base-content.opacity-80 Country
              = f.select :country, [['Vietnam', 'vn'], ['USA', 'us'], ['Global', 'global']], { selected: 'vn' }, class: "w-full p-3 bg-base-100 border border-base-300 rounded-lg text-base-content"
            = f.submit "ğŸ“¦ Create Order", class: "btn btn-primary w-full"

          = form_with url: paid_order_demo_index_path, method: :post, local: true, class: "mb-6" do |f|
            h3.text-xl.font-bold.mb-4 ğŸ’° Paid Order
            .mb-4
              label.block.text-sm.font-semibold.mb-2.text-base-content.opacity-80 Country
              = f.select :country, [['Vietnam', 'vn'], ['USA', 'us']], { selected: 'vn' }, class: "w-full p-3 bg-base-100 border border-base-300 rounded-lg text-base-content"
            = f.submit "ğŸ’° Paid Order", class: "btn btn-primary w-full"

          = form_with url: shipped_order_demo_index_path, method: :post, local: true, class: "mb-6" do |f|
            h3.text-xl.font-bold.mb-4 ğŸšš Shipped Order
            .mb-4
              label.block.text-sm.font-semibold.mb-2.text-base-content.opacity-80 Country
              = f.select :country, [['Vietnam', 'vn'], ['USA', 'us']], { selected: 'vn' }, class: "w-full p-3 bg-base-100 border border-base-300 rounded-lg text-base-content"
            = f.submit "ğŸšš Shipped Order", class: "btn btn-primary w-full"

          = form_with url: direct_exchange_demo_demo_index_path, method: :post, local: true, class: "mb-6" do |f|
            h3.text-xl.font-bold.mb-4 ğŸ¯ Direct Exchange Demo
            .mb-4
              label.block.text-sm.font-semibold.mb-2.text-base-content.opacity-80 Priority
              = f.select :priority, [['High', 'high'], ['Medium', 'medium'], ['Low', 'low']], { selected: 'high' }, class: "w-full p-3 bg-base-100 border border-base-300 rounded-lg text-base-content"
            = f.submit "ğŸ¯ Direct Exchange", class: "btn btn-primary w-full"

          = form_with url: headers_exchange_demo_demo_index_path, method: :post, local: true do |f|
            h3.text-xl.font-bold.mb-4 ğŸ”– Headers Exchange Demo
            .mb-4
              label.block.text-sm.font-semibold.mb-2.text-base-content.opacity-80 Format
              = f.select :format, [['PDF', 'pdf'], ['DOCX', 'docx'], ['XLSX', 'xlsx']], { selected: 'pdf' }, class: "w-full p-3 bg-base-100 border border-base-300 rounded-lg text-base-content"
            .mb-4
              label.block.text-sm.font-semibold.mb-2.text-base-content.opacity-80 Priority
              = f.select :priority, [['High', 'high'], ['Medium', 'medium'], ['Low', 'low']], { selected: 'high' }, class: "w-full p-3 bg-base-100 border border-base-300 rounded-lg text-base-content"
            .mb-4
              label.block.text-sm.font-semibold.mb-2.text-base-content.opacity-80 Size
              = f.select :size, [['Large', 'large'], ['Medium', 'medium'], ['Small', 'small']], { selected: 'large' }, class: "w-full p-3 bg-base-100 border border-base-300 rounded-lg text-base-content"
            = f.submit "ğŸ”– Headers Exchange", class: "btn btn-primary w-full"

        .bg-base-100.border.border-base-300.rounded-lg.p-4.mt-6.min-h-32.max-h-80.overflow-y-auto
          pre#rabbitmq-response.text-sm.font-mono.text-base-content
            | ğŸ“‹ RabbitMQ Activity Log
            |
            | Ready to publish messages!
            |
            | ğŸ’¡ Tips:
            | â€¢ "ğŸ“¦ Create Order" â†’ Topic + Fanout Exchange
            | â€¢ "ğŸ’° Paid Order" â†’ Topic Exchange routing
            | â€¢ "ğŸšš Shipped Order" â†’ Topic Exchange routing
            | â€¢ "ğŸ¯ Direct Exchange" â†’ Priority-based routing
            | â€¢ "ğŸ”– Headers Exchange" â†’ Header-based routing
            |
            | Check console logs for message routing details
            | Last activity: None yet

javascript:
  // Format large numbers
  function formatNumber(num) {
    if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
    if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
    return num.toString();
  }

  // Format latency
  function formatLatency(ms) {
    if (ms >= 1000) return (ms / 1000).toFixed(1) + 's';
    return ms + 'ms';
  }

  // Update stats display
  function updateStats() {
    fetch('/demo/stats')
      .then(response => response.json())
      .then(data => {
        // Update Sidekiq stats
        if (data.sidekiq) {
          const sidekiq = data.sidekiq;
          document.getElementById('sidekiq-processed').textContent = formatNumber(sidekiq.processed || 0);
          document.getElementById('sidekiq-workers').textContent = sidekiq.workers || 0;
          document.getElementById('sidekiq-failed').textContent = formatNumber(sidekiq.failed || 0);
          document.getElementById('sidekiq-latency').textContent = formatLatency(sidekiq.latency || 0);
        }

        // Update RabbitMQ stats
        if (data.rabbitmq) {
          const rabbitmq = data.rabbitmq;
          document.getElementById('rabbitmq-messages').textContent = formatNumber(rabbitmq.messages || 0);
          document.getElementById('rabbitmq-connections').textContent = rabbitmq.connections || 0;
          document.getElementById('rabbitmq-queues').textContent = rabbitmq.queues || 5;
          document.getElementById('rabbitmq-latency').textContent = formatLatency(rabbitmq.latency || 0);

          // Update connection status color
          const connectionEl = document.getElementById('rabbitmq-connections');
          if (rabbitmq.connected) {
            connectionEl.classList.remove('text-red-500');
            connectionEl.classList.add('text-green-500');
          } else {
            connectionEl.classList.remove('text-green-500');
            connectionEl.classList.add('text-red-500');
          }
        }
      })
      .catch(err => {
        console.error('Error loading stats:', err);
        // Show error state
        document.getElementById('sidekiq-processed').textContent = '?';
        document.getElementById('rabbitmq-messages').textContent = '?';
      });
  }

  // Update response boxes when forms are submitted
  function updateSidekiqResponse(message, type = 'info') {
    const responseBox = document.getElementById('sidekiq-response');
    const timestamp = new Date().toLocaleTimeString();
    const color = type === 'success' ? 'text-green-500' : type === 'error' ? 'text-red-500' : 'text-blue-500';

    const currentContent = responseBox.textContent;
    const newEntry = `[${timestamp}] ${message}`;

    // Keep last 10 entries
    const lines = currentContent.split('\n').filter(line => line.trim());
    const activityLines = lines.filter(line => line.includes('[') && line.includes(']'));
    activityLines.push(newEntry);
    const recentActivity = activityLines.slice(-10).join('\n');

    responseBox.innerHTML = `<span class="text-base-content">ğŸ“‹ Sidekiq Activity Log</span>\n\n<span class="${color}">${recentActivity}</span>\n\n<span class="text-base-content opacity-70">ğŸ’¡ Check /sidekiq for detailed job status</span>`;
  }

  function updateRabbitmqResponse(message, type = 'info') {
    const responseBox = document.getElementById('rabbitmq-response');
    const timestamp = new Date().toLocaleTimeString();
    const color = type === 'success' ? 'text-green-500' : type === 'error' ? 'text-red-500' : 'text-blue-500';

    const currentContent = responseBox.textContent;
    const newEntry = `[${timestamp}] ${message}`;

    // Keep last 10 entries
    const lines = currentContent.split('\n').filter(line => line.trim());
    const activityLines = lines.filter(line => line.includes('[') && line.includes(']'));
    activityLines.push(newEntry);
    const recentActivity = activityLines.slice(-10).join('\n');

    responseBox.innerHTML = `<span class="text-base-content">ğŸ“‹ RabbitMQ Activity Log</span>\n\n<span class="${color}">${recentActivity}</span>\n\n<span class="text-base-content opacity-70">ğŸ’¡ Check console logs for routing details</span>`;
  }

  // Listen for flash messages and update response boxes
  document.addEventListener('DOMContentLoaded', function() {
    updateStats();
    setInterval(updateStats, 3000); // Refresh every 3 seconds

    // Check for flash messages and update response boxes
    const successFlash = document.querySelector('.alert-success');
    const errorFlash = document.querySelector('.alert-error');

    if (successFlash) {
      const message = successFlash.textContent.trim();
      if (message.includes('Email') || message.includes('Image')) {
        updateSidekiqResponse(message, 'success');
      } else if (message.includes('Order') || message.includes('Exchange') || message.includes('Published')) {
        updateRabbitmqResponse(message, 'success');
      }
    }

    if (errorFlash) {
      const message = errorFlash.textContent.trim();
      if (message.includes('Sidekiq') || message.includes('Email') || message.includes('Image')) {
        updateSidekiqResponse(message, 'error');
      } else {
        updateRabbitmqResponse(message, 'error');
      }
    }

    // Listen for form submissions
    document.querySelectorAll('form').forEach(form => {
      form.addEventListener('submit', function(e) {
        const formAction = form.action;
        const submitButton = form.querySelector('input[type="submit"]');
        const buttonText = submitButton ? submitButton.value : '';

        // Show loading state
        if (formAction.includes('send_email') || formAction.includes('process_image')) {
          updateSidekiqResponse(`â³ Queuing job: ${buttonText}...`, 'info');
        } else if (formAction.includes('demo')) {
          updateRabbitmqResponse(`â³ Publishing message: ${buttonText}...`, 'info');
        }
      });
    });
  });
