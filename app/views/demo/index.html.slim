- provide(:title, "RabbitMQ & Sidekiq Demo")

section.py-16.bg-base-100
  .container.mx-auto.px-4
    h1.text-center.mb-12.text-4xl.md:text-5xl.font-bold.text-orange-500.flex.items-center.justify-center.gap-3
      = lucide_icon(:demo, class: 'w-12 h-12')
      | Live Demo: RabbitMQ vs Sidekiq

    - if flash[:success]
      .alert.alert-success.mb-6.shadow-lg
        = flash[:success]
    - if flash[:error]
      .alert.alert-error.mb-6.shadow-lg
        = flash[:error]

    .grid.grid-cols-1.lg:grid-cols-2.gap-8
      .bg-base-200.border-2.border-green-500.rounded-xl.p-8.transition-all.hover:-translate-y-1.hover:shadow-lg
        .flex.items-center.gap-4.mb-6.pb-4.border-b-2.border-base-300
          = lucide_icon(:sidekiq, class: 'w-12 h-12 text-green-500')
          .text-3xl.font-bold.text-green-500 Sidekiq Demo

        .bg-orange-500.bg-opacity-10.border.border-orange-500.rounded-lg.p-4.mb-6
          h4.text-orange-500.font-bold.mb-2 About Sidekiq
          p.text-sm.text-base-content.opacity-80 Fast, simple background job processing for Ruby. Perfect for Rails monoliths with straightforward job queuing needs.

        .grid.grid-cols-2.gap-4.mb-8
          = render 'demo/partials/stats_card', id: 'sidekiq-processed', value: '0', label: 'Processed'
          = render 'demo/partials/stats_card', id: 'sidekiq-workers', value: '0', label: 'Workers'
          = render 'demo/partials/stats_card', id: 'sidekiq-failed', value: '0', label: 'Failed'
          = render 'demo/partials/stats_card', id: 'sidekiq-latency', value: '0ms', label: 'Latency'

        = render 'demo/partials/demo_form',
            url: send_email_demo_index_path,
            form_class: 'mb-6',
            icon: lucide_icon(:email, class: 'w-5 h-5'),
            title: 'Send Email Job',
            fields: [{ type: :text_field, name: :email, value: default_email, placeholder: 'user@example.com', label: 'Email Address' }],
            submit_text: 'Send Email Job',
            button_class: 'btn-success'

        = render 'demo/partials/demo_form',
            url: process_image_demo_index_path,
            form_class: 'mb-6',
            icon: lucide_icon(:image, class: 'w-5 h-5'),
            title: 'Process Image',
            fields: [{ type: :text_field, name: :image_url, value: default_image_url, placeholder: 'https://...', label: 'Image URL' }],
            submit_text: 'Process Image',
            button_class: 'btn-success'

        .bg-base-100.border.border-base-300.rounded-lg.p-4.mt-6.min-h-32.max-h-80.overflow-y-auto
          pre#sidekiq-response.text-sm.font-mono.text-base-content
            | ğŸ“‹ Sidekiq Activity Log
            |
            | Ready to process background jobs!
            |
            | ğŸ’¡ Tips:
            | â€¢ Click "ğŸ“§ Send Email Job" to queue an email worker
            | â€¢ Click "ğŸ–¼ï¸ Process Image" to queue an image processor
            | â€¢ Check /sidekiq for detailed job status
            | â€¢ Jobs will appear here once queued
            |
            | Last activity: None yet

      .bg-base-200.border-2.border-orange-500.rounded-xl.p-8.transition-all.hover:-translate-y-1.hover:shadow-lg
        .flex.items-center.gap-4.mb-6.pb-4.border-b-2.border-base-300
          = lucide_icon(:rabbitmq, class: 'w-12 h-12 text-orange-500')
          .text-3xl.font-bold.text-orange-500 RabbitMQ Demo

        .bg-orange-500.bg-opacity-10.border.border-orange-500.rounded-lg.p-4.mb-6
          h4.text-orange-500.font-bold.mb-2 About RabbitMQ
          p.text-sm.text-base-content.opacity-80 Enterprise message broker with powerful routing. Ideal for microservices, event-driven architecture, and complex messaging patterns.

        .grid.grid-cols-2.gap-4.mb-8
          = render 'demo/partials/stats_card', id: 'rabbitmq-messages', value: '0', label: 'Messages'
          = render 'demo/partials/stats_card', id: 'rabbitmq-connections', value: '0', label: 'Connections'
          = render 'demo/partials/stats_card', id: 'rabbitmq-queues', value: '5', label: 'Queues'
          = render 'demo/partials/stats_card', id: 'rabbitmq-latency', value: '0ms', label: 'Latency'

        = render 'demo/partials/demo_form',
            url: create_order_demo_index_path,
            form_class: 'space-y-6',
            icon: lucide_icon(:order, class: 'w-5 h-5'),
            title: 'Create Order (Topic Exchange)',
            fields: [
              { type: :text_field, name: :product, value: default_product, label: 'Product' },
              { type: :number_field, name: :amount, value: default_amount, label: 'Amount' },
              { type: :select, name: :country, options: country_options, selected: default_country, label: 'Country' }
            ],
            submit_text: 'Create Order',
            button_class: 'btn-primary'

        = render 'demo/partials/demo_form',
            url: paid_order_demo_index_path,
            form_class: 'mb-6',
            icon: lucide_icon(:paid, class: 'w-5 h-5'),
            title: 'Paid Order',
            fields: [{ type: :select, name: :country, options: country_options_short, selected: default_country, label: 'Country' }],
            submit_text: 'Paid Order',
            button_class: 'btn-primary'

        = render 'demo/partials/demo_form',
            url: shipped_order_demo_index_path,
            form_class: 'mb-6',
            icon: lucide_icon(:shipped, class: 'w-5 h-5'),
            title: 'Shipped Order',
            fields: [{ type: :select, name: :country, options: country_options_short, selected: default_country, label: 'Country' }],
            submit_text: 'Shipped Order',
            button_class: 'btn-primary'

        = render 'demo/partials/demo_form',
            url: direct_exchange_demo_demo_index_path,
            form_class: 'mb-6',
            icon: lucide_icon(:direct, class: 'w-5 h-5'),
            title: 'Direct Exchange Demo',
            fields: [{ type: :select, name: :priority, options: priority_options, selected: 'high', label: 'Priority' }],
            submit_text: 'Direct Exchange',
            button_class: 'btn-primary'

        = render 'demo/partials/demo_form',
            url: headers_exchange_demo_demo_index_path,
            form_class: '',
            icon: lucide_icon(:headers, class: 'w-5 h-5'),
            title: 'Headers Exchange Demo',
            fields: [
              { type: :select, name: :format, options: format_options, selected: 'pdf', label: 'Format' },
              { type: :select, name: :priority, options: priority_options, selected: 'high', label: 'Priority' },
              { type: :select, name: :size, options: size_options, selected: 'large', label: 'Size' }
            ],
            submit_text: 'Headers Exchange',
            button_class: 'btn-primary'

        .bg-base-100.border.border-base-300.rounded-lg.p-4.mt-6.min-h-32.max-h-80.overflow-y-auto
          pre#rabbitmq-response.text-sm.font-mono.text-base-content
            | ğŸ“‹ RabbitMQ Activity Log
            |
            | Ready to publish messages!
            |
            | ğŸ’¡ Tips:
            | â€¢ "ğŸ“¦ Create Order" â†’ Topic + Fanout Exchange
            | â€¢ "ğŸ’° Paid Order" â†’ Topic Exchange routing
            | â€¢ "ğŸšš Shipped Order" â†’ Topic Exchange routing
            | â€¢ "ğŸ¯ Direct Exchange" â†’ Priority-based routing
            | â€¢ "ğŸ”– Headers Exchange" â†’ Header-based routing
            |
            | Check console logs for message routing details
            | Last activity: None yet

javascript:
  // Format large numbers
  function formatNumber(num) {
    if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
    if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
    return num.toString();
  }

  // Format latency
  function formatLatency(ms) {
    if (ms >= 1000) return (ms / 1000).toFixed(1) + 's';
    return ms + 'ms';
  }

  // Update stats display
  function updateStats() {
    fetch('/demo/stats')
      .then(response => response.json())
      .then(data => {
        // Update Sidekiq stats
        if (data.sidekiq) {
          const sidekiq = data.sidekiq;
          document.getElementById('sidekiq-processed').textContent = formatNumber(sidekiq.processed || 0);
          document.getElementById('sidekiq-workers').textContent = sidekiq.workers || 0;
          document.getElementById('sidekiq-failed').textContent = formatNumber(sidekiq.failed || 0);
          document.getElementById('sidekiq-latency').textContent = formatLatency(sidekiq.latency || 0);
        }

        // Update RabbitMQ stats
        if (data.rabbitmq) {
          const rabbitmq = data.rabbitmq;
          document.getElementById('rabbitmq-messages').textContent = formatNumber(rabbitmq.messages || 0);
          document.getElementById('rabbitmq-connections').textContent = rabbitmq.connections || 0;
          document.getElementById('rabbitmq-queues').textContent = rabbitmq.queues || 5;
          document.getElementById('rabbitmq-latency').textContent = formatLatency(rabbitmq.latency || 0);

          // Update connection status color
          const connectionEl = document.getElementById('rabbitmq-connections');
          if (rabbitmq.connected) {
            connectionEl.classList.remove('text-red-500');
            connectionEl.classList.add('text-green-500');
          } else {
            connectionEl.classList.remove('text-green-500');
            connectionEl.classList.add('text-red-500');
          }
        }
      })
      .catch(err => {
        console.error('Error loading stats:', err);
        // Show error state
        document.getElementById('sidekiq-processed').textContent = '?';
        document.getElementById('rabbitmq-messages').textContent = '?';
      });
  }

  // Update response boxes when forms are submitted
  function updateSidekiqResponse(message, type = 'info') {
    const responseBox = document.getElementById('sidekiq-response');
    const timestamp = new Date().toLocaleTimeString();
    const color = type === 'success' ? 'text-green-500' : type === 'error' ? 'text-red-500' : 'text-blue-500';

    const currentContent = responseBox.textContent;
    const newEntry = `[${timestamp}] ${message}`;

    // Keep last 10 entries
    const lines = currentContent.split('\n').filter(line => line.trim());
    const activityLines = lines.filter(line => line.includes('[') && line.includes(']'));
    activityLines.push(newEntry);
    const recentActivity = activityLines.slice(-10).join('\n');

    responseBox.innerHTML = `<span class="text-base-content">ğŸ“‹ Sidekiq Activity Log</span>\n\n<span class="${color}">${recentActivity}</span>\n\n<span class="text-base-content opacity-70">ğŸ’¡ Check /sidekiq for detailed job status</span>`;
  }

  function updateRabbitmqResponse(message, type = 'info') {
    const responseBox = document.getElementById('rabbitmq-response');
    const timestamp = new Date().toLocaleTimeString();
    const color = type === 'success' ? 'text-green-500' : type === 'error' ? 'text-red-500' : 'text-blue-500';

    const currentContent = responseBox.textContent;
    const newEntry = `[${timestamp}] ${message}`;

    // Keep last 10 entries
    const lines = currentContent.split('\n').filter(line => line.trim());
    const activityLines = lines.filter(line => line.includes('[') && line.includes(']'));
    activityLines.push(newEntry);
    const recentActivity = activityLines.slice(-10).join('\n');

    responseBox.innerHTML = `<span class="text-base-content">ğŸ“‹ RabbitMQ Activity Log</span>\n\n<span class="${color}">${recentActivity}</span>\n\n<span class="text-base-content opacity-70">ğŸ’¡ Check console logs for routing details</span>`;
  }

  // Listen for flash messages and update response boxes
  document.addEventListener('DOMContentLoaded', function() {
    updateStats();
    setInterval(updateStats, 3000); // Refresh every 3 seconds

    // Check for flash messages and update response boxes
    const successFlash = document.querySelector('.alert-success');
    const errorFlash = document.querySelector('.alert-error');

    if (successFlash) {
      const message = successFlash.textContent.trim();
      if (message.includes('Email') || message.includes('Image')) {
        updateSidekiqResponse(message, 'success');
      } else if (message.includes('Order') || message.includes('Exchange') || message.includes('Published')) {
        updateRabbitmqResponse(message, 'success');
      }
    }

    if (errorFlash) {
      const message = errorFlash.textContent.trim();
      if (message.includes('Sidekiq') || message.includes('Email') || message.includes('Image')) {
        updateSidekiqResponse(message, 'error');
      } else {
        updateRabbitmqResponse(message, 'error');
      }
    }

    // Listen for form submissions
    document.querySelectorAll('form').forEach(form => {
      form.addEventListener('submit', function(e) {
        const formAction = form.action;
        const submitButton = form.querySelector('input[type="submit"]');
        const buttonText = submitButton ? submitButton.value : '';

        // Show loading state
        if (formAction.includes('send_email') || formAction.includes('process_image')) {
          updateSidekiqResponse(`â³ Queuing job: ${buttonText}...`, 'info');
        } else if (formAction.includes('demo')) {
          updateRabbitmqResponse(`â³ Publishing message: ${buttonText}...`, 'info');
        }
      });
    });
  });
